# CLAUDE.md

このファイルは、このリポジトリでコードを扱う際にClaude Code (claude.ai/code) にガイダンスを提供します。

## プロジェクト概要

これは原神のChrome拡張機能で、HoYoLABのコミュニティゲーム戦績ページで聖遺物のスコア計算を行います。この拡張機能は、ハイライトされた追加ステータスに基づいて聖遺物表示にスコア計算を追加します。

## コアアーキテクチャ

### 主要コンポーネント
- `manifest.json`: HoYoLAB戦績ページを対象とするChrome拡張機能のマニフェスト（v3）
- `content.js`: スコア計算機能を注入するメインコンテンツスクリプト
- `README.md`: インストールと使用方法の日本語ドキュメント

### 主要な技術詳細

**対象URL**: `https://act.hoyolab.com/app/community-game-records-sea/index.html`

**コンテンツスクリプトアーキテクチャ**:
- 初期化に`document.addEventListener('DOMContentLoaded')`を使用
- 動的なDOM変更を監視するMutationObserverパターンを実装
- Promise基盤の`waitForElement()`関数を使用して要素を待機
- 追加ステータス（`subPropsElementObserve`）とキャラクター情報（`basicInfoElementObserve`）の監視を維持

**スコア計算システム**:
- 公式ページでユーザーが選択したハイライト追加ステータスに基づいてスコアを計算
- 一般的な1:2:1の比率ではなく、会心ダメージ:会心率:攻撃力%の正確な比率を使用
- すべての聖遺物タイプ（花、羽、砂、杯、冠）をサポート
- スコア計算式は追加ステータスのタイプによって異なる（例：会心率 × 2.0、攻撃力%/HP% × 62.2/46.6）

**DOM操作**:
- ID `alk-element`でカスタムUI要素を作成
- 一貫した外観のために既存ページのスタイルをコピー
- 聖遺物リスト（`relic-list`）の上にスコア表示を挿入

### 使用されている要素セレクタ
- `.relic-list`: メインの聖遺物コンテナ
- `.sub-props .prop-list`: ハイライト追加ステータス選択エリア
- `.basic-info`: キャラクター情報セクション
- `.artifact-sub-prop`: 個別の聖遺物追加ステータス要素
- `.final-text`: 数値スタイリングの参照要素

## 開発ノート

- 拡張機能は日本語ユーザー向けに設計されている（すべてのテキストが日本語）
- ビルドプロセス不要 - 直接Chrome拡張機能の読み込み
- JSDoc型注釈を使用したバニラJavaScript
- 要素の可視性チェックによる防御的プログラミングを実装
- 適切な監視のクリーンアップで動的コンテンツ読み込みを処理

## インストール方法

この拡張機能はパッケージ化されていない読み込み方法を使用：
1. ファイルをダウンロードして展開
2. Chrome拡張機能でデベロッパーモードを有効化
3. パッケージ化されていない拡張機能フォルダを読み込み
4. 対象ページで拡張機能が自動的にアクティブ化

## 言語とローカライゼーション

現在日本語のみ。READMEに記載されているように、将来的に多言語サポートを予定。

## オリジナルページHTML構造（拡張無効時）

Chrome拡張が操作する`class="character-content"`内のオリジナルHTML構造：

```html
<!-- キャラステータス + 聖遺物 -->
<div class="character-content"> 
  <!-- 中略（キャラクター選択タブ、ブロックタイトルなど） -->
  <!-- キャラステータス -->
  <div class="top-info"> 
    <!-- 中略（キャラ画像、天賦レベル、好感度、凸数） -->
    <!-- 
      【.basic-info】キャラクターの基本情報（名前、レベル、星、ステータス）を表示する要素
      この要素の変更を監視することでキャラクター変更を検知 
    -->
    <div class="basic-info">
      <!-- 中略（キャラクター名、レベル、キャラレア度） -->
      <!-- ステータス情報 -->
      <div> 
        <!-- 中略（ラベル"ステータス"） -->
        <div class="prop-list">
          <div class="prop-item1">
            <!-- 中略（HPの数値以外の要素） -->
            <!-- 【.final-text】数値表示のスタイル参照用クラス -->
            <p class="final-text">HPの数値</p>
          </div>
          <!-- 中略（prop-item-2～10で他のステータスを表示） -->
        </div>
      </div>
    </div>
  </div>

  <!-- 【.artifact-info】聖遺物全体の情報コンテナ -->
  <div class="artifact-info">
    <!-- 中略（「ハイライトするステータスの選択」ボタン） -->
    <div>
      <!-- ハイライトするステータス選択 -->
      <div class="mark-props">
        <div class="main-props">
          <!-- 中略（メインステータス） -->
        </div>
        <!-- 
          【.sub-props .prop-list】ユーザーが選択したハイライト追加ステータスの一覧
          .prop-item__activeクラスが選択状態を示し、選択アイコンが表示される
          Chrome拡張はここからスコア計算対象のステータス名を取得
          Chrome拡張はMutationObserverでこの要素の変更を監視
        -->
        <div class="sub-props">
          <!-- 中略（ラベル「追加ステータス」） -->
          <div class="prop-list">
            <div class="prop-item">
              <!-- 中略（追加ステータスの名称） -->
            </div>
            <!-- 中略（追加ステータスの数だけprop-itemが存在） -->
          </div>
        </div>
      </div>

      <!-- 【.split】区切り線要素（Chrome拡張はこの直後にスコア表示を挿入） -->
      <div class="split"></div>
      <!-- 
        【.relic-list】5つの聖遺物（花、羽、砂、杯、冠）を横並びで表示
        Chrome拡張はこの要素の親要素内に#alk-elementでスコア表示UIを挿入
      -->
      <div class="relic-list">
        <!-- 【.relic-item】個別の聖遺物要素 -->
        <div class="relic-item">
          <!-- 中略（聖遺物の名称、画像、レベル） -->
          <!-- 【.main-prop】聖遺物のメインステータス -->
          <div class="main-prop">
            <!-- 中略（ステータスの名称と値） -->
          </div>
          <!-- 
            【.artifact-sub-prop】聖遺物のサブステータスの個別要素
            .artifact-sub-prop__activeクラスを持つ場合、スコア対象のサブステータス
            Chrome拡張はこの要素からステータス名と数値を解析してスコア計算
          -->
          <div class="artifact-sub-prop artifact-sub-prop__active">
            <!-- 中略（ステータスの名称と値） -->
          </div>
          <!-- 中略（サブステータスの数だけartifact-sub-propが存在） -->
        </div>
        <!-- 中略（聖遺物の数だけrelic-itemが存在） -->
      </div>
    </div>
  </div>
</div>
```

## 改善タスクリスト

### 高優先度（機能性・保守性の向上）

- [ ] **UIコンポーネントの分離**: `createScoreElement()`内のUI生成ロジックを別ファイル（`ui-components.js`）に分離し、再利用可能な形で整理する
- [ ] **設定の外部化**: スコア計算の倍率や定数を`config.js`として分離し、修正時の影響範囲を限定する  
- [ ] **スコア計算ロジックの分離**: `getScore()`や`calculateScore()`を`score-calculator.js`として独立させ、テスト可能な形にする
- [ ] **エラーハンドリングの強化**: `draw()`関数のTODOコメント部分や各async関数でのエラー処理を実装する
- [ ] **DOM操作の共通化**: 要素作成やスタイル適用の処理を`dom-utils.js`に切り出し、重複コードを削減する

### 中優先度（コード品質の向上）

- [ ] **クラス化によるリファクタリング**: グローバル変数や関数を`GenshinScoreCalculator`クラスにまとめ、名前空間を整理する
- [ ] **定数の整理**: `PROP_NAME`オブジェクトをファイル先頭の`SELECTORS`と同じ場所に移動し、設定として統一する
- [ ] **型安全性の向上**: JSDocの型注釈をより詳細に記述し、IDE支援と開発効率を向上させる
- [ ] **関数の単一責任化**: `setup()`関数を機能別（スタイル取得、要素取得、監視設定）に分割する
- [ ] **非同期処理の最適化**: `reDraw()`内の逐次処理を並列化し、パフォーマンスを向上させる

### 低優先度（拡張性・メンテナンス性）

- [ ] **国際化対応**: 日本語文字列をメッセージファイルに分離し、多言語対応の基盤を作る
- [ ] **設定UI追加**: スコア計算方式（普及型/厳密型）の切り替えや元素チャージ効率上限の設定機能を実装する
- [ ] **ログ機能追加**: デバッグ用のログ出力機能を追加し、問題発生時の調査を容易にする
- [ ] **パフォーマンス監視**: MutationObserver の呼び出し頻度監視とスロットリング機能を追加する
- [ ] **ユニットテスト追加**: スコア計算ロジックのテストケースを作成し、仕様変更時の安全性を確保する

### ファイル構成案

```
/
├── manifest.json
├── content.js (メインエントリポイント)
├── modules/
│   ├── config.js (設定・定数)
│   ├── score-calculator.js (スコア計算ロジック)
│   ├── ui-components.js (UI生成機能)
│   ├── dom-utils.js (DOM操作ユーティリティ)
│   └── observer-manager.js (MutationObserver管理)
└── _locales/ (将来の国際化対応)
    └── ja/
        └── messages.json
```

### 主要な問題点の分析

**現在のcontent.jsの課題:**
1. **単一ファイルに全機能集約**: 487行のコードが1ファイルに集中し、保守性が低い
2. **UI生成の複雑性**: `createScoreElement()`が286-377行と長大で、DOM操作が混在している
3. **グローバル変数の多用**: 8個のグローバル変数が関数間で共有され、予期しない副作用のリスクがある
4. **ハードコードされた設定**: スコア計算の倍率や文字列が関数内に分散している
5. **エラー処理の不備**: 多くの箇所でエラーハンドリングが不十分
6. **非同期処理の非効率性**: `reDraw()`内で逐次待機処理が行われている

ユーザーの指摘通り、機能別にファイルを分離することで、各モジュールの責任を明確化し、テスト可能性と保守性を大幅に向上させることができます。